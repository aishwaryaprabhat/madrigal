# MADRIGAL: A blueprint for Distributed GenAI Red Teaming using open-source tooling
 ![The Lute Player (c.â€‰1600) by Caravaggio. The lutenist reads madrigal music by the composer Jacques Arcadelt. (Hermitage, Saint Petersburg)](assets/image.jpeg)
A Kubernetes-native reference architecture for performing and tracking distributed GenAI Red Teaming using open-source technologies such as Garak, Ray and MLFlow


## Code Overview

Below is a table describing the main code-related files and folders in this repository.

| File / Folder                                                               | Description                                                                                                                                                                                                                                                                                                         |
|-----------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [SETUP.md](SETUP.md)                                                        | Contains a detailed **installation guide** for setting up a multi-node Kubernetes cluster using MicroK8s, deploying Argo CD, and configuring MLflow, KubeRay, and Kubeflow Pipelines.  |
| [k8s/bootstrap/microk8s_setup.sh](k8s/bootstrap/microk8s_setup.sh)         | A **script** for setting up a multi-node MicroK8s cluster, including node joining and essential add-on configurations. It simplifies the process of creating and maintaining a Kubernetes environment on platforms like Digital Ocean.                                                                            |
| [k8s/bootstrap/argocd_setup.sh](k8s/bootstrap/argocd_setup.sh)             | A **bash script** that installs and initializes Argo CD on your Kubernetes cluster. Running this sets up the Argo CD namespace, controller, and server, providing a central UI for continuous delivery of your applications.                                                                                       |
| [k8s/argocd_apps](k8s/argocd_apps)                                          | This folder contains **YAML files** that Argo CD uses to create and manage various applications, such as Kubeflow Pipelines, MLflow, MinIO, and RayCluster. When these files are applied and synced, Argo CD synchronizes and deploys the configurations in your Kubernetes environment.                        |
| [k8s/bootstrap/useful_commands.sh](k8s/bootstrap/useful_commands.sh)       | A **shell script** with convenient commands for port-forwarding services, retrieving secrets (for Argo CD or Argo Workflows), and terminating processes on specific ports. It serves as a quick reference for frequent tasks in a Kubernetes + Argo + Kubeflow environment.                                        |
| [src/verify_connections.ipynb](src/verify_connections.ipynb)              | A **Jupyter notebook** for testing connectivity to components in the K8s cluster, such as Ray, Kubeflow Pipelines and MLflow.                                                                                                   |
| [src/download_hf_model.ipynb](src/download_hf_model.ipynb)                | A **notebook** for downloading a model from Hugging Face and logging it to MLflow. This model is used as the LLM against which Red Teaming is performed. The model used in this example is `HuggingFaceTB/SmolLM2-135M-Instruct`                                                                                                    |
| [src/distributed_redteaming.ipynb](src/distributed_redteaming.ipynb)       | A short **Jupyter notebook** for running the distributed red teaming interactively to get a sense of what is happening.                                                                                                                                         |
| [src/custom_generator.py](src/custom_generator.py)                         | A **Python script** that downloads a model from MLflow and defines a custom text-generation function. This is used in the [src/distributed_redteaming.ipynb](src/distributed_redteaming.ipynb) notebook as the generator function passed to garak for Red Teaming |
| [src/distrt_pipeline.py](src/distrt_pipeline.py)                           | A **Python script** defining a Kubeflow pipeline that performs distributed Red Teaming non-interactively. The Kubeflow pipeline generated by this code can be found in [src/madrigal_pipeline.yaml](src/madrigal_pipeline.yaml) |
| [src/kfp_launcher.ipynb](src/kfp_launcher.ipynb)                           | A **Jupyter notebook** demonstrating how to compile, register and run the Kubeflow Pipeline programmatically. It allows you to experiment with pipeline settings and trigger runs without manually using the Kubeflow UI.                                                                                                   |
